# Description:  BPF Compiler Collection
# URL:          https://github.com/iovisor/bcc
# Maintainer:   fun, just.the.real.fun at gmail dot com
# Depends on:   clang elfutils python3
# Nice to have: luajit iperf

name=bcc
version=0.5.0
release=2
source=(https://github.com/iovisor/bcc/archive/v$version/bcc-$version.tar.gz .watch
	# drop this when version > 0.5.0
	https://github.com/iovisor/bcc/commit/c0d1694e28336cbe4a57f420dd33c5e3bfaa2df9.patch
)

build() {
	patch -d */ -p1 < $SRC/c0d1694e28336cbe4a57f420dd33c5e3bfaa2df9.patch

	# no tests
	ed -s */CMakeLists.txt <<-EOF
		/add_subdirectory(tests)/d
		/add_subdirectory(examples)/d
		w
	EOF

	# with DESTDIR=$PKG some are still installed directly to /usr
	# and we need to fix src/python/setup.py.in too
	opts=(
		-DREVISION=$version
		-DPYTHON_CMD=python3
		-DCMAKE_INSTALL_PREFIX=$PKG/usr
		-DCMAKE_INSTALL_LIBDIR=$PKG/usr/lib
	)
	cmake */ "${opts[@]}"
	cmake --build . --target install

	mv $PKG/usr/share/bcc/man $PKG/usr/share/
}
